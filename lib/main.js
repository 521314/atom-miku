var CompositeDisposable, AtomMiku, MikuView;
var $ = require('jquery');

MikuView = require('./miku-view');

CompositeDisposable = require('atom').CompositeDisposable;

module.exports = AtomMiku = {
    mikuView: null,
    elem: null,
    toggle: null,
    typing: null,
    subscriptions: null,
    disposableEditor: null,
    activate: function(state) {
        var that = this;
        this.mikuView = new MikuView(state.mikuViewState);
        this.elem = this.mikuView.getElement();
        console.log(this.elem);
        document.querySelector('.workspace').appendChild(this.elem);
        this.mikuView.initEventBind();
        this.mikuView.miku = window.frames[this.mikuView.iframeName];
        this.subscriptions = new CompositeDisposable;
        var editor = atom.workspace.getActiveTextEditor();
        /*
        * 注册atom事件
        * toggle 事件暂存在this.subscriptions
        * textChange事件单独存
        * */
        this.subscriptions.add(atom.commands.add('atom-workspace', {
            'AtomMiku:toggle': ( function(_this) {
                return function() {
                    return _this.toggle();
                };
            } )(this)
        }));

        /*
        * 插件激活时监听当前
        * */
        if (editor) {
          this.typing = editor.onDidChange(function() {
              that.mikuView.addFrame(1.5);
          });
        }

        /*
        * 切换时
        * */
        this.subscriptions.add(atom.workspace.onDidChangeActivePaneItem(function(item){
          var activeEditor = atom.workspace.getActiveTextEditor();

          if (that.typing) {
            that.typing.dispose();
            that.typing = null;
          }

          if (activeEditor) {
              that.typing = activeEditor.onDidChange(function() {
                  that.mikuView.addFrame(1.5);
              });
          }

        }));

        this.windowBlurHandler = function() {
            if (that.elem.style.display == 'block' && that.mikuView) {
                that.mikuView.pause();
            }
        }

        this.windowFocusHandler = function() {
            if (that.elem.style.display == 'block' && that.mikuView) {
                that.mikuView.play();
            }
        }

        window.addEventListener('blur', this.windowBlurHandler, false);
        window.addEventListener('focus', this.windowFocusHandler, false);
    },
    deactivate: function() {
        window.removeEventListener('blur', this.windowBlurHandler, false);
        window.removeEventListener('focus', this.windowFocusHandler, false);
        this.subscriptions.dispose();
        if (this.typing) this.typing.dispose();
        $(this.elem).html('');
    },
    serialize: function() {
        return {
            mikuViewState: this.mikuView.serialize()
        };
    },
    toggle: function() {
         if (this.elem.style.display == 'block') {
             this.mikuView.pause();
             this.elem.style.display = 'none';
         } else {
             this.mikuView.play();
             this.elem.style.display = 'block';
         }
    }
};

// ---
// generated by coffee-script 1.9.2
